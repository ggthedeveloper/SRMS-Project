<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SRM AP Student Portal</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .captcha-box {
            background-color: #b5ccf258;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 10px 10px;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.2em;
            text-decoration: line-through;
            color: #475569;
            font-weight: bold;
            font-style: italic;
        }

        /* COLLAPSED SIDEBAR */
        .sidebar-collapsed {
            width: 70px !important;
            transition: width 200ms ease;
        }

        .sidebar-collapsed .sidebar-title {
            display: none;
        }

        .sidebar-collapsed nav button span {
            display: none;
        }

        .sidebar-collapsed nav button {
            justify-content: center;
        }

        .sidebar-collapsed nav button i {
            margin-right: 0;
        }

        /* Smooth sidebar width transition */
        #sidebar {
            transition: width 200ms ease, transform 200ms ease;
        }
    
/* Hide logout text when collapsed */
.sidebar-collapsed button span {
    display: none !important;
}
/* Center logout icon when collapsed */
.sidebar-collapsed button {
    justify-content: center !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
}
.sidebar-collapsed .p-4 {
    padding-left: 0 !important;
    padding-right: 0 !important;
}

</style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">

    <!-- ================= LOGIN SCREEN ================= -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center p-4">
        <div class="bg-white-50 w-full max-w-md rounded-2xl shadow-xl overflow-hidden fade-in border border-slate-200">
            <div class="bg-blue-100 p-6 text-center border-b border-slate-100">
                <h1 class="text-slate-800 text-xl font-bold mt-2">SRM University AP</h1>
                <p class="text-slate-500 text-sm">Student Record Management System</p>
            </div>

            <div class="p-8">
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Username / Name</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-3 top-3 text-slate-400 w-5 h-5"></i>
                            <input type="text" id="loginName" placeholder="Enter your name" class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Password</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-3 top-3 text-slate-400 w-5 h-5"></i>
                            <input type="password" id="loginPassword" placeholder="Enter password" class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Security Captcha</label>
                        <div class="flex gap-3">
                            <div id="captcha-display" class="captcha-box flex-1 border border-slate-300 rounded-lg flex items-center justify-center text-2xl select-none cursor-not-allowed h-12"></div>
                            <button type="button" onclick="generateCaptcha()" class="p-2 bg-slate-100 border border-slate-300 rounded-lg hover:bg-slate-200 transition-colors" title="Refresh Captcha">
                                <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-600"></i>
                            </button>
                        </div>
                        <input type="text" id="loginCaptcha" placeholder="Type the characters above" class="w-full mt-2 px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" required>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg transition-all flex items-center justify-center gap-2">
                        <i data-lucide="log-in" class="w-4 h-4"></i>
                        <span>Login</span>
                    </button>
                </form>
            </div>
            <div class="bg-slate-50 p-4 text-center border-t border-slate-100">
                <p class="text-xs text-slate-400">© 2024 SRM University AP. All Rights Reserved.</p>
            </div>
        </div>
    </div>

    <!-- ================= ADMIN SETUP SCREEN ================= -->
    <div id="admin-setup-screen" class="hidden fixed inset-0 z-50 bg-slate-100 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl overflow-hidden fade-in border border-slate-200">
            <div class="bg-white p-6 border-b border-slate-100 flex flex-col items-center">
                <h2 class="text-xl font-bold text-slate-800">Administrator Setup</h2>
                <p class="text-slate-500 text-sm">Please complete your profile to continue</p>
            </div>

            <div class="p-8">
                <form onsubmit="handleAdminSetup(event)" class="space-y-6">
                    <div class="flex flex-col items-center gap-3">
                        <div class="relative">
                            <div id="adminPhotoPreview" class="w-24 h-24 rounded-full bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden">
                                <i data-lucide="camera" class="w-8 h-8 text-slate-400"></i>
                            </div>
                            <label for="adminPhotoInput" class="absolute bottom-0 right-0 bg-blue-600 text-white p-1.5 rounded-full cursor-pointer hover:bg-blue-700 shadow-sm">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                            </label>
                            <input type="file" id="adminPhotoInput" accept="image/*" class="hidden" onchange="previewAdminPhoto(this)">
                        </div>
                        <p class="text-xs text-slate-400">Upload Profile Photo</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Full Name</label>
                            <input type="text" id="adminSetupName" placeholder="Administrator Name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Employee / Admin ID</label>
                            <input type="text" id="adminSetupId" placeholder="e.g. ADM001" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Official Email ID</label>
                        <input type="email" id="adminSetupEmail" placeholder="admin@srmap.edu.in" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>

                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 rounded-lg transition-all flex items-center justify-center gap-2 mt-2">
                        <span>Go to Dashboard</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ================= APP LAYOUT ================= -->
    <div id="app-layout" class="hidden h-full flex w-full relative">
        <aside id="sidebar" class="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col transition-transform duration-300 z-50 fixed inset-y-0 left-0 md:relative md:translate-x-0 -translate-x-full shadow-2xl md:shadow-none">
            <div class="p-6 flex flex-col gap-4 border-b border-slate-700 bg-white">
                <div class="sidebar-title">
                    <h1 class="font-bold text-lg leading-none text-slate-900">SRM AP Student Portal</h1>
                    <span class="text-xs text-slate-500">Academic Records</span>
                </div>
            </div>

            <nav class="mt-6 px-3 flex-1">
                <button onclick="switchTab('dashboard'); closeSidebarOnMobile()" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 mb-2 rounded-lg transition-colors bg-blue-600 text-white shadow-lg shadow-blue-900/50">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </button>
                <button onclick="switchTab('students'); closeSidebarOnMobile()" id="nav-students" class="w-full flex items-center gap-3 px-4 py-3 mb-2 rounded-lg transition-colors text-slate-400 hover:bg-slate-800 hover:text-white">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="font-medium">Students Directory</span>
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button onclick="handleLogout()" class="flex items-center gap-3 text-slate-400 hover:text-red-400 w-full px-4 py-2 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden fade-in"></div>

        <div class="flex-1 flex flex-col overflow-hidden relative bg-slate-50 w-full h-full">
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <button class="md:hidden text-slate-500 p-2 hover:bg-slate-100 rounded-lg" onclick="toggleSidebar()">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>

                    <!-- Collapse / Expand Button (desktop) -->
                    <button id="collapseBtn" onclick="toggleCollapse()" 
                        class="hidden md:flex text-slate-500 p-2 hover:bg-slate-100 rounded-lg">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="flex items-center gap-4 ml-auto">
                    <div class="text-right hidden sm:block">
                        <span class="text-sm font-medium text-slate-800 block" id="headerAdminName">Admin User</span>
                        <span class="text-xs text-slate-500 block" id="headerAdminId">Administrator</span>
                    </div>
                    <div id="headerAdminAvatar" class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold border border-blue-200 overflow-hidden">A</div>
                </div>
            </header>

            <main class="flex-1 overflow-auto p-6" id="main-content">
                <!-- DASHBOARD VIEW -->
                <div id="view-dashboard" class="fade-in">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Dashboard Overview</h2>
                        <p class="text-slate-500">Welcome back to the SRM AP Student Portal.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <!-- Total -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-500 text-sm font-medium mb-1">Total Students</p><h3 class="text-2xl font-bold text-slate-800" id="stat-total">0</h3></div>
                                <div class="p-3 rounded-lg bg-blue-500 text-white"><i data-lucide="users" class="w-6 h-6"></i></div>
                            </div>
                        </div>
                        <!-- CSE -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-500 text-sm font-medium mb-1">CSE Dept</p><h3 class="text-2xl font-bold text-slate-800" id="stat-cse">0</h3></div>
                                <div class="p-3 rounded-lg bg-purple-500 text-white"><i data-lucide="book-open" class="w-6 h-6"></i></div>
                            </div>
                        </div>
                        <!-- AVG CGPA -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-500 text-sm font-medium mb-1">Avg CGPA</p><h3 class="text-2xl font-bold text-slate-800" id="stat-cgpa">0.00</h3></div>
                                <div class="p-3 rounded-lg bg-emerald-500 text-white"><i data-lucide="graduation-cap" class="w-6 h-6"></i></div>
                            </div>
                        </div>
                        <!-- Probation -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-500 text-sm font-medium mb-1">Probation/Fail</p><h3 class="text-2xl font-bold text-slate-800" id="stat-probation">0</h3></div>
                                <div class="p-3 rounded-lg bg-amber-500 text-white"><i data-lucide="school" class="w-6 h-6"></i></div>
                            </div>
                        </div>
                    </div>

            <!-- CHARTS ROW -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Department Bar Chart -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Department-wise Students</h3>
                    <canvas id="deptChart" height="140"></canvas>
                </div>

                <!-- CGPA Distribution -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">CGPA Distribution</h3>
                    <canvas id="cgpaChart" height="140"></canvas>
                </div>
            </div>

            YEAR-WISE CHART
            <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 mb-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Year-wise Student Count</h3>
                <canvas id="yearChart" height="120"></canvas>
            </div>

                    <div id="dashboard-empty" class="bg-white p-12 rounded-xl border border-slate-200 text-center hidden">
                        <div class="inline-flex p-4 bg-slate-50 rounded-full mb-4"><i data-lucide="clipboard-list" class="w-8 h-8 text-slate-400"></i></div>
                        <h3 class="text-lg font-medium text-slate-700">No Data Available</h3>
                        <p class="text-slate-500 mt-1">Add students in the directory to see statistics here.</p>
                        <button onclick="switchTab('students'); openModal()" class="mt-4 text-blue-600 hover:text-blue-700 font-medium text-sm">Add First Student &rarr;</button>
                    </div>
                </div>

                <!-- STUDENTS VIEW -->
                <div id="view-students" class="hidden fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Student Directory</h2>
                            <p class="text-slate-500">Manage student records and academic details.</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors shadow-sm shadow-emerald-200">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>Download Excel</span>
                            </button>
                            <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors shadow-sm shadow-blue-200">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Add Student</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3 mb-6">
                        <i data-lucide="search" class="text-slate-400 w-5 h-5"></i>
                        <input type="text" id="searchInput" placeholder="Search by name, ID, or department..." class="flex-1 outline-none text-slate-700 placeholder-slate-400" onkeyup="renderStudents()">
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-semibold">
                                    <tr>
                                        <th class="px-6 py-4">Student Info</th>
                                        <th class="px-6 py-4">Nationality</th>
                                        <th class="px-6 py-4">Academic</th>
                                        <th class="px-6 py-4">Section/Sem</th>
                                        <th class="px-6 py-4">CGPA</th>
                                        <th class="px-6 py-4">Status</th>
                                        <th class="px-6 py-4 text-center">Courses</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div id="table-empty" class="hidden p-12 text-center text-slate-400">
                            <div class="flex flex-col items-center gap-2"><i data-lucide="search" class="w-8 h-8 opacity-20"></i><p>No students found. Add one to get started!</p></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Student Form Modal -->
    <div id="studentModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg m-auto mt-6 overflow-hidden animate-[fadeIn_0.2s_ease-out] flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                <h3 class="font-bold text-lg text-slate-800" id="modalTitle">Add New Student</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="studentForm" onsubmit="handleFormSubmit(event)" class="space-y-4">
                    <input type="hidden" id="editIndex">

                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Student Photo</label>
                        <div class="flex items-center gap-4">
                            <div id="photoPreview" class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center border border-slate-200 overflow-hidden">
                                <i data-lucide="user" class="text-slate-400 w-8 h-8"></i>
                            </div>
                            <input type="file" id="inpPhoto" accept="image/*" class="text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="previewPhoto(this)">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Registration ID</label>
                            <input type="text" id="inpId" required placeholder="AP24..." maxlength="13" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Full Name</label>
                            <input type="text" id="inpName" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Email</label>
                        <input type="email" id="inpEmail" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Nationality Field -->
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Nationality</label>
                        <div class="flex gap-4 pt-1">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="nationality" value="Indian" checked class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">Indian</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="nationality" value="International" class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">International</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Dept</label>
                            <select id="inpDept" onchange="toggleSpecialization()" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="CSE">CSE</option>
                                <option value="ECE">ECE</option>
                                <option value="EEE">EEE</option>
                                <option value="MECH">MECH</option>
                                <option value="CIVIL">CIVIL</option>
                                <option value="CHEM">CHEM</option>
                                <option value="MATHS">MATHS</option>
                                <option value="PHY">PHY</option>
                            </select>
                        </div>
                        <div class="space-y-1 hidden" id="specContainer">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Specialization</label>
                            <select id="inpSpec" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Core">Core</option>
                                <option value="AI/ML">AI/ML</option>
                                <option value="Data Science">Data Science</option>
                                <option value="Cyber Security">Cyber Security</option>
                                <option value="Cloud Computing">Cloud Computing</option>
                                <option value="IoT">IoT</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Year</label>
                            <select id="inpYear" onchange="updateSemesterOptions()" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Semester</label>
                            <select id="inpSem" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Section</label>
                            <select id="inpSection" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <!-- Options Generated by JS -->
                            </select>
                            <p class="text-[10px] text-slate-400">Max 67 students/section</p>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">CGPA (Max 10)</label>
                            <input type="number" id="inpCgpa" step="0.01" min="0" max="10" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Residency</label>
                        <div class="flex gap-4 pt-1">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="residency" value="Hosteler" checked class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">Hosteler</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="residency" value="Day Scholar" class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">Day Scholar</span>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">Status</label>
                        <div class="flex gap-4 pt-1">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="status" value="Active" checked class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">Active</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="status" value="Probation" class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">Probation</span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg mt-4 flex items-center justify-center gap-2 transition-all">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>Save Student</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Course Management Modal with Calculator -->
    <div id="courseModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCourseModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl m-auto mt-10 overflow-hidden flex flex-col max-h-[85vh] animate-[fadeIn_0.2s_ease-out]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="font-bold text-lg text-slate-800">Manage Courses & CGPA</h3>
                    <p class="text-xs text-slate-500" id="courseModalStudentName">Student Name</p>
                </div>
                <button onclick="closeCourseModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                    <h4 class="text-sm font-semibold text-slate-700 mb-3">Add Enrolled Course</h4>
                    <form onsubmit="handleAddCourse(event)" class="flex gap-2 flex-wrap sm:flex-nowrap">
                        <input type="text" id="courseCode" placeholder="Code" required class="w-20 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="courseName" placeholder="Course Name" required class="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="courseGrade" required class="w-24 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Grade</option>
                            <option value="O">O (10)</option>
                            <option value="A+">A+ (9)</option>
                            <option value="A">A (8)</option>
                            <option value="B+">B+ (7)</option>
                            <option value="B">B (6)</option>
                            <option value="C">C (5)</option>
                            <option value="F">F (0)</option>
                        </select>
                        <input type="number" id="courseCredits" placeholder="Cr" min="1" max="10" required class="w-16 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">Add</button>
                    </form>
                </div>

                <h4 class="text-sm font-semibold text-slate-700 mb-3">Enrolled Courses</h4>
                <div class="border rounded-lg overflow-hidden mb-4">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 text-slate-500 font-medium">
                            <tr>
                                <th class="px-4 py-2">Code</th>
                                <th class="px-4 py-2">Course Name</th>
                                <th class="px-4 py-2">Grade</th>
                                <th class="px-4 py-2">Credit</th>
                                <th class="px-4 py-2 text-right">Action</th>
                            </tr>
                        </thead>
        
                        <tbody id="courseTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                    <div id="noCoursesMsg" class="p-4 text-center text-slate-400 hidden">No courses enrolled yet.</div>
                </div>

                <!-- Calculator Result -->
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 flex justify-between items-center">
                    <div>
                        <p class="text-xs text-blue-600 font-bold uppercase">Calculated CGPA</p>
                        <h2 class="text-2xl font-bold text-blue-800" id="calculatedCgpaDisplay">0.00</h2>
                        <p class="text-xs text-blue-500" id="calculationDetails">0 Credits Total</p>
                    </div>
                    <button onclick="applyCalculatedCGPA()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        Apply to Profile
                    </button>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 flex justify-end">
                <button onclick="closeCourseModal()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors">Done</button>
            </div>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script>
        // --- State ---
        let students = []; 
        let editingId = null;
        let currentCourseStudentId = null;
        let tempPhotoData = null;
        let adminPhotoData = null;
        let currentCaptcha = "";
        let admin = null;
        let loggedIn = false;
        const STORAGE_KEY = 'srms_state';

        // Chart instances
        let deptChart = null;
        let cgpaChart = null;
        let yearChart = null;

        // Grade Points Mapping
        const gradePoints = { 'O': 10, 'A+': 9, 'A': 8, 'B+': 7, 'B': 6, 'C': 5, 'F': 0 };

        function saveState() {
            const state = { students: students, admin: admin, loggedIn: loggedIn };
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) {}
        }

        function loadState() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const state = JSON.parse(raw);
                students = Array.isArray(state.students) ? state.students : [];
                admin = state.admin || null;
                loggedIn = !!state.loggedIn;
                if (admin && loggedIn) {
                    document.getElementById('headerAdminName').innerText = admin.name || '';
                    document.getElementById('headerAdminId').innerText = (admin.id || '') + " | " + (admin.email || '');
                    if (admin.photo) {
                        document.getElementById('headerAdminAvatar').innerHTML = `<img src="${admin.photo}" class="w-full h-full object-cover">`;
                    } else {
                        const n = admin.name || '';
                        document.getElementById('headerAdminAvatar').innerText = n ? n.charAt(0).toUpperCase() : 'A';
                    }
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('admin-setup-screen').classList.add('hidden');
                    document.getElementById('app-layout').classList.remove('hidden');
                }
            } catch (e) {}
        }

        // --- Sections Logic ---
        function generateSectionOptions() {
            const select = document.getElementById('inpSection');
            select.innerHTML = "";
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const options = [];
            // A-Z
            for(let i=0; i<26; i++) options.push(letters[i]);
            // AA-AF
            for(let i=0; i<6; i++) options.push('A' + letters[i]);

            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.innerText = opt;
                select.appendChild(el);
            });
        }

        // --- Login Logic ---
        function generateCaptcha() {
            const chars = "ABCDEFGHJKMNPQRSTUVWXYZ0123456789"; 
            let result = "";
            for(let i=0; i<6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            currentCaptcha = result;
            document.getElementById('captcha-display').innerText = result.split('').join(' ');
        }

        function handleLogin(e) {
            e.preventDefault();
            const name = document.getElementById('loginName').value;
            const password = document.getElementById('loginPassword').value;
            const userCaptcha = document.getElementById('loginCaptcha').value.toUpperCase();

            if (password !== "SRMS@123") {
                alert("Incorrect Password!");
                return;
            }
            if(userCaptcha !== currentCaptcha) {
                alert("Incorrect Captcha. Please try again.");
                generateCaptcha();
                document.getElementById('loginCaptcha').value = "";
                return;
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('adminSetupName').value = name;
            document.getElementById('admin-setup-screen').classList.remove('hidden');
            lucide.createIcons();
        }

        // --- Admin Setup Logic ---
        function previewAdminPhoto(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    adminPhotoData = e.target.result;
                    document.getElementById('adminPhotoPreview').innerHTML = `<img src="${adminPhotoData}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleAdminSetup(e) {
            e.preventDefault();
            const name = document.getElementById('adminSetupName').value;
            const id = document.getElementById('adminSetupId').value;
            const email = document.getElementById('adminSetupEmail').value;

            document.getElementById('headerAdminName').innerText = name;
            document.getElementById('headerAdminId').innerText = id + " | " + email;
            if(adminPhotoData) {
                document.getElementById('headerAdminAvatar').innerHTML = `<img src="${adminPhotoData}" class="w-full h-full object-cover">`;
            } else {
                document.getElementById('headerAdminAvatar').innerText = name.charAt(0).toUpperCase();
            }

            admin = { name: name, id: id, email: email, photo: adminPhotoData || null };
            loggedIn = true;

            document.getElementById('admin-setup-screen').classList.add('hidden');
            document.getElementById('app-layout').classList.remove('hidden');
            lucide.createIcons();

            // initial render once admin logs in
            renderStudents();
            renderDashboard();
            renderDeptChart();
            renderCgpaChart();
            renderYearChart();
            saveState();
        }

        // --- UI Functions ---
        function switchTab(tab) {
            document.querySelectorAll('#sidebar nav button').forEach(btn => {
                btn.className = "w-full flex items-center gap-3 px-4 py-3 mb-2 rounded-lg transition-colors text-slate-400 hover:bg-slate-800 hover:text-white";
            });
            document.getElementById(`nav-${tab}`).className = "w-full flex items-center gap-3 px-4 py-3 mb-2 rounded-lg transition-colors bg-blue-600 text-white shadow-lg shadow-blue-900/50";
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-students').classList.add('hidden');
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            lucide.createIcons();
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function closeSidebarOnMobile() {
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }
        }

        function handleLogout() {
            if(confirm("Are you sure you want to logout?")) {
                loggedIn = false;
                saveState();
                window.location.reload();
            }
        }

        // --- Render Logic ---
        function renderDashboard() {
            const total = students.length;
            const cse = students.filter(s => s.dept === 'CSE').length;
            const probation = students.filter(s => s.status === 'Probation').length;
            const avg = total > 0 ? (students.reduce((acc, curr) => acc + parseFloat(curr.cgpa), 0) / total).toFixed(2) : "0.00";

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-cse').innerText = cse;
            document.getElementById('stat-probation').innerText = probation;
            document.getElementById('stat-cgpa').innerText = avg;

            if (total === 0) document.getElementById('dashboard-empty').classList.remove('hidden');
            else document.getElementById('dashboard-empty').classList.add('hidden');
        }

        function renderStudents() {
            const tbody = document.getElementById('studentsTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = students.filter(s => 
                s.name.toLowerCase().includes(search) || 
                s.id.toLowerCase().includes(search) || 
                s.dept.toLowerCase().includes(search)
            );

            tbody.innerHTML = '';
            if (filtered.length === 0) {
                document.getElementById('table-empty').classList.remove('hidden');
                return;
            }
            document.getElementById('table-empty').classList.add('hidden');

            filtered.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors group border-b border-slate-100";

                const statusClass = s.status === 'Active' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-amber-50 text-amber-600 border-amber-100';
                const cgpaColor = parseFloat(s.cgpa) >= 9 ? 'text-emerald-600' : (parseFloat(s.cgpa) <= 5 ? 'text-red-600' : 'text-slate-700');
                const courseCount = s.courses ? s.courses.length : 0;
                const natBadge = s.nationality === 'International' 
                    ? '<span class="ml-2 text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200">INTL</span>' 
                    : '<span class="ml-2 text-[10px] bg-orange-50 text-orange-700 px-1.5 py-0.5 rounded border border-orange-200">IND</span>';

                let avatarHtml = '';
                if(s.photo) avatarHtml = `<img src="${s.photo}" class="w-10 h-10 rounded-full object-cover border border-slate-200">`;
                else avatarHtml = `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm">${s.name.charAt(0)}</div>`;

                let deptDisplay = s.dept;
                if(s.dept === 'CSE' && s.spec) deptDisplay += ` <span class="text-[10px] text-slate-400 block">${s.spec}</span>`;

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            ${avatarHtml}
                            <div>
                                <div class="font-medium text-slate-900">${s.name}</div>
                                <div class="text-xs text-slate-500">${s.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-slate-700 flex items-center">${natBadge}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium">${deptDisplay}</div>
                        <div class="text-xs text-slate-500">Year ${s.year} • ${s.residency}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold">Sec ${s.section}</span>
                        <div class="text-xs text-slate-500 mt-1">Sem ${s.sem}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold ${cgpaColor}">${s.cgpa}</div>
                        ${parseFloat(s.cgpa) <= 5.0 ? '<span class="text-[10px] text-red-500 font-bold">FAIL</span>' : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-medium border ${statusClass}">${s.status}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="openCourseModal('${s.id}')" class="text-sm bg-slate-100 hover:bg-blue-50 hover:text-blue-600 text-slate-600 px-3 py-1.5 rounded-lg border border-slate-200 transition-colors flex items-center gap-2 mx-auto">
                            <i data-lucide="book-open" class="w-4 h-4"></i>
                            <span>${courseCount}</span>
                        </button>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2 opacity-60 hover:opacity-100 transition-opacity">
                            <button onclick="editStudent('${s.id}')" title="Edit" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="deleteStudent('${s.id}')" title="Delete" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- CRUD Logic ---
        function toggleSpecialization() {
            const dept = document.getElementById('inpDept').value;
            const specDiv = document.getElementById('specContainer');
            if(dept === 'CSE') specDiv.classList.remove('hidden');
            else specDiv.classList.add('hidden');
        }

        function updateSemesterOptions() {
            const year = document.getElementById('inpYear').value;
            const semSelect = document.getElementById('inpSem');
            semSelect.innerHTML = "";

            let sems = [];
            if(year === "1") sems = [1, 2];
            else if(year === "2") sems = [3, 4];
            else if(year === "3") sems = [5, 6];
            else if(year === "4") sems = [7, 8];

            sems.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.innerText = s;
                semSelect.appendChild(opt);
            });
        }

        function previewPhoto(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempPhotoData = e.target.result;
                    document.getElementById('photoPreview').innerHTML = `<img src="${tempPhotoData}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function openModal() {
            document.getElementById('studentForm').reset();
            document.getElementById('modalTitle').innerText = "Add New Student";
            document.getElementById('inpId').disabled = false;
            document.getElementById('editIndex').value = "";
            editingId = null;
            tempPhotoData = null;
            document.getElementById('photoPreview').innerHTML = '<i data-lucide="user" class="text-slate-400 w-8 h-8"></i>';
            toggleSpecialization();
            // Reset to default Year 1 logic
            document.getElementById('inpYear').value = "1";
            updateSemesterOptions();

            document.getElementById('studentModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('studentModal').classList.add('hidden');
        }

        function handleFormSubmit(e) {
            e.preventDefault();

            const idVal = document.getElementById('inpId').value.toUpperCase();
            const cgpaVal = parseFloat(document.getElementById('inpCgpa').value);
            const deptVal = document.getElementById('inpDept').value;
            const specVal = document.getElementById('inpSpec').value;
            const sectionVal = document.getElementById('inpSection').value;

            // Validations
            if (!idVal.startsWith("AP")) { alert("Registration ID must start with 'AP'."); return; }
            if (idVal.length > 13) { alert("Registration ID cannot exceed 13 characters."); return; }
            if (cgpaVal > 10) { alert("CGPA cannot be greater than 10."); return; }

            // Capacity Check: Max 67
            const sectionCount = students.filter(s => s.section === sectionVal && s.id !== editingId).length;
            if (sectionCount >= 67) {
                alert(`Section ${sectionVal} is full (Max 67 students). Please choose another section.`);
                return;
            }

            const formData = {
                id: idVal,
                name: document.getElementById('inpName').value,
                email: document.getElementById('inpEmail').value,
                dept: deptVal,
                spec: deptVal === 'CSE' ? specVal : '', 
                year: document.getElementById('inpYear').value,
                sem: document.getElementById('inpSem').value,
                section: sectionVal,
                cgpa: cgpaVal.toFixed(2),
                residency: document.querySelector('input[name="residency"]:checked').value,
                nationality: document.querySelector('input[name="nationality"]:checked').value,
                status: document.querySelector('input[name="status"]:checked').value,
                photo: tempPhotoData || null,
                courses: [] 
            };

            if (editingId) {
                const index = students.findIndex(s => s.id === editingId);
                if (index !== -1) {
                    formData.courses = students[index].courses || [];
                    if(!tempPhotoData && students[index].photo) formData.photo = students[index].photo;
                    students[index] = formData;
                }
            } else {
                if (students.some(s => s.id === formData.id)) { alert("Student ID already exists!"); return; }
                students.push(formData);
            }

            renderStudents();
            renderDashboard();
            // update charts
            renderDeptChart();
            renderCgpaChart();
            renderYearChart();
            saveState();
            closeModal();
        }

        function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;

            editingId = id;
            document.getElementById('modalTitle').innerText = "Edit Student";
            document.getElementById('inpId').value = student.id;
            document.getElementById('inpId').disabled = true; 
            document.getElementById('inpName').value = student.name;
            document.getElementById('inpEmail').value = student.email;
            document.getElementById('inpDept').value = student.dept;
            toggleSpecialization();
            if(student.dept === 'CSE') document.getElementById('inpSpec').value = student.spec;

            // Set year first, update options, then set sem
            document.getElementById('inpYear').value = student.year;
            updateSemesterOptions();
            document.getElementById('inpSem').value = student.sem;

            document.getElementById('inpSection').value = student.section;
            document.getElementById('inpCgpa').value = student.cgpa;

            // Radio Buttons
            const radios = document.getElementsByName('status');
            for(let r of radios) if(r.value === student.status) r.checked = true;

            const resRadios = document.getElementsByName('residency');
            for(let r of resRadios) if(r.value === student.residency) r.checked = true;

            const natRadios = document.getElementsByName('nationality');
            for(let r of natRadios) if(r.value === student.nationality) r.checked = true;

            const preview = document.getElementById('photoPreview');
            if(student.photo) {
                preview.innerHTML = `<img src="${student.photo}" class="w-full h-full object-cover">`;
                tempPhotoData = null;
            } else {
                preview.innerHTML = '<i data-lucide="user" class="text-slate-400 w-8 h-8"></i>';
            }

            document.getElementById('studentModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function deleteStudent(id) {
            if(confirm("Are you sure you want to delete this student?")) {
                students = students.filter(s => s.id !== id);
                renderStudents();
                renderDashboard();
                // update charts
                renderDeptChart();
                renderCgpaChart();
                renderYearChart();
                saveState();
            }
        }

        // --- Course Logic ---
        function openCourseModal(id) {
            currentCourseStudentId = id;
            const student = students.find(s => s.id === id);
            if (!student) return;
            document.getElementById('courseModalStudentName').innerText = `${student.name} (${student.id})`;
            if(!student.courses) student.courses = [];
            renderCourseList();
            document.getElementById('courseModal').classList.remove('hidden');
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.add('hidden');
            currentCourseStudentId = null;
            renderStudents(); 
            renderDashboard();
            renderDeptChart();
            renderCgpaChart();
            renderYearChart();
        }

        function calculateCGPA(courses) {
            let totalPoints = 0;
            let totalCredits = 0;
            courses.forEach(c => {
                const points = gradePoints[c.grade] || 0;
                const cred = parseInt(c.credits) || 0;
                totalPoints += (points * cred);
                totalCredits += cred;
            });
            return totalCredits === 0 ? "0.00" : (totalPoints / totalCredits).toFixed(2);
        }

        function renderCourseList() {
            const student = students.find(s => s.id === currentCourseStudentId);
            const tbody = document.getElementById('courseTableBody');
            tbody.innerHTML = '';

            // Update Calculated CGPA display
            const calcCgpa = calculateCGPA(student.courses);
            const totalCreds = student.courses.reduce((acc, curr) => acc + (parseInt(curr.credits) || 0), 0);

            document.getElementById('calculatedCgpaDisplay').innerText = calcCgpa;
            document.getElementById('calculationDetails').innerText = `${totalCreds} Credits Total`;

            if (student.courses.length === 0) {
                document.getElementById('noCoursesMsg').classList.remove('hidden');
            } else {
                document.getElementById('noCoursesMsg').classList.add('hidden');
                student.courses.forEach((c, index) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="px-4 py-3 font-medium text-slate-700">${c.code}</td>
                        <td class="px-4 py-3 text-slate-600">${c.name}</td>
                        <td class="px-4 py-3"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold">${c.grade}</span></td>
                        <td class="px-4 py-3 text-slate-600">${c.credits}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="deleteCourse(${index})" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            lucide.createIcons();
        }

        function handleAddCourse(e) {
            e.preventDefault();
            const student = students.find(s => s.id === currentCourseStudentId);
            if(!student) return;

            const newCourse = {
                code: document.getElementById('courseCode').value,
                name: document.getElementById('courseName').value,
                grade: document.getElementById('courseGrade').value,
                credits: document.getElementById('courseCredits').value
            };

            student.courses.push(newCourse);
            saveState();

            document.getElementById('courseCode').value = '';
            document.getElementById('courseName').value = '';
            document.getElementById('courseGrade').value = '';
            document.getElementById('courseCredits').value = '';
            document.getElementById('courseCode').focus();

            renderCourseList();
            // update calculated display automatically shown; charts not updated until apply
        }

        function deleteCourse(index) {
            const student = students.find(s => s.id === currentCourseStudentId);
            if(!student) return;
            student.courses.splice(index, 1);
            saveState();
            renderCourseList();
        }

        function applyCalculatedCGPA() {
            const student = students.find(s => s.id === currentCourseStudentId);
            if(!student) return;

            const newCgpa = calculateCGPA(student.courses);
            student.cgpa = newCgpa;

            // Check fail status update if CGPA drops
            if(parseFloat(newCgpa) <= 5.0) {
                student.status = 'Probation';
            }

            alert(`Updated ${student.name}'s CGPA to ${newCgpa}`);
            renderStudents(); // Update main table
            renderDashboard();
            renderDeptChart();
            renderCgpaChart();
            renderYearChart();
            saveState();
        }

        // --- Charts Logic ---

        function renderDeptChart() {
            const ctx = document.getElementById('deptChart').getContext('2d');
            const departments = ["CSE","ECE","EEE","MECH","CIVIL","CHEM","MATHS","PHY"];
            const deptCounts = departments.map(d => students.filter(s => s.dept === d).length);

            if (deptChart) deptChart.destroy();

            deptChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: departments,
                    datasets: [{
                        label: 'Students Count',
                        data: deptCounts,
                        backgroundColor: ['#3b82f6','#6366f1','#22c55e','#f97316','#ef4444','#14b8a6','#a855f7','#0ea5e9'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false }},
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function renderCgpaChart() {
            const ctx = document.getElementById('cgpaChart').getContext('2d');
            const buckets = ["0–4","4–5","5–6","6–7","7–8","8–9","9–10"];
            const counts = [0,0,0,0,0,0,0];

            students.forEach(s => {
                const c = parseFloat(s.cgpa);
                if (isNaN(c)) return;
                if (c < 4) counts[0]++;
                else if (c < 5) counts[1]++;
                else if (c < 6) counts[2]++;
                else if (c < 7) counts[3]++;
                else if (c < 8) counts[4]++;
                else if (c < 9) counts[5]++;
                else counts[6]++;
            });

            if (cgpaChart) cgpaChart.destroy();

            cgpaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: buckets,
                    datasets: [{
                        label: 'Number of Students',
                        data: counts,
                        backgroundColor: '#6366f1',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false }},
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function renderYearChart() {
            const ctx = document.getElementById('yearChart').getContext('2d');
            const years = ["1st","2nd","3rd","4th"];
            const yearCounts = [
                students.filter(s => s.year === "1").length,
                students.filter(s => s.year === "2").length,
                students.filter(s => s.year === "3").length,
                students.filter(s => s.year === "4").length
            ];

            if (yearChart) yearChart.destroy();

            yearChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Students',
                        data: yearCounts,
                        borderColor: '#0ea5e9',
                        borderWidth: 2,
                        tension: 0.35,
                        pointBackgroundColor: '#0284c7',
                        pointRadius: 5,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false }},
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // --- Sidebar Collapse Logic ---
        function toggleCollapse() {
            const sidebar = document.getElementById("sidebar");
            const collapseBtn = document.getElementById("collapseBtn");

            sidebar.classList.toggle("sidebar-collapsed");

            // Update button icon
            collapseBtn.innerHTML = sidebar.classList.contains("sidebar-collapsed")
                ? '<i data-lucide="chevron-right" class="w-6 h-6"></i>'
                : '<i data-lucide="chevron-left" class="w-6 h-6"></i>';

            lucide.createIcons();
        }

        // --- Excel Export Function ---
        function exportToExcel() {
            if (students.length === 0) {
                alert("No student data available to export.");
                return;
            }

            // Prepare data for Excel
            const excelData = students.map(student => ({
                'Registration ID': student.id,
                'Full Name': student.name,
                'Email': student.email,
                'Department': student.dept,
                'Specialization': student.spec || 'N/A',
                'Year': student.year,
                'Semester': student.sem,
                'Section': student.section,
                'CGPA': student.cgpa,
                'Residency': student.residency,
                'Nationality': student.nationality,
                'Status': student.status,
                'Courses Count': student.courses ? student.courses.length : 0,
                'Courses Details': student.courses ? student.courses.map(c => `${c.code}: ${c.name} (${c.grade}, ${c.credits}cr)`).join('; ') : 'No courses'
            }));

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Auto-size columns
            const colWidths = [
                { wch: 15 }, // Registration ID
                { wch: 20 }, // Full Name
                { wch: 25 }, // Email
                { wch: 10 }, // Department
                { wch: 15 }, // Specialization
                { wch: 5 },  // Year
                { wch: 8 },  // Semester
                { wch: 7 },  // Section
                { wch: 6 },  // CGPA
                { wch: 12 }, // Residency
                { wch: 12 }, // Nationality
                { wch: 8 },  // Status
                { wch: 12 }, // Courses Count
                { wch: 50 }  // Courses Details
            ];
            ws['!cols'] = colWidths;

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Students Data");

            // Generate filename with current date
            const now = new Date();
            const filename = `SRMS_Students_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.xlsx`;

            // Save file
            XLSX.writeFile(wb, filename);
        }

        // --- Init ---
        loadState();
        toggleSpecialization();
        generateCaptcha();
        generateSectionOptions();
        lucide.createIcons();

        // Render empty stats/charts initially
        renderStudents();
        renderDashboard();
        renderDeptChart();
        renderCgpaChart();
        renderYearChart();

        
        

    </script>
</body>
</html>
